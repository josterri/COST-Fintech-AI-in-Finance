name: Update Publications Data

on:
  # Run quarterly (1st day of Jan, Apr, Jul, Oct at 2:00 AM UTC)
  schedule:
    - cron: '0 2 1 1,4,7,10 *'

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      skip_fetch:
        description: 'Skip API fetching (only run combine/cleanup)'
        required: false
        default: 'false'
        type: boolean
      force_update:
        description: 'Force update even if large changes detected'
        required: false
        default: 'false'
        type: boolean

env:
  # Maximum allowed change percentage before blocking update
  MAX_CHANGE_PERCENT: 15

jobs:
  update-publications:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas openpyxl

      - name: Save current publication count
        id: before
        run: |
          if [ -f data/publications_apa.json ]; then
            OLD_COUNT=$(python -c "import json; print(json.load(open('data/publications_apa.json'))['metadata']['total_publications'])")
            OLD_AUTHORS=$(python -c "import json; print(json.load(open('data/publications_apa.json'))['metadata']['total_authors'])")
          else
            OLD_COUNT=0
            OLD_AUTHORS=0
          fi
          echo "old_count=$OLD_COUNT" >> $GITHUB_OUTPUT
          echo "old_authors=$OLD_AUTHORS" >> $GITHUB_OUTPUT
          echo "Previous: $OLD_COUNT publications, $OLD_AUTHORS authors"

      - name: Extract and validate ORCIDs
        if: ${{ github.event.inputs.skip_fetch != 'true' }}
        run: python scripts/extract_and_validate_orcids.py

      - name: Fetch OpenAlex publications
        if: ${{ github.event.inputs.skip_fetch != 'true' }}
        run: python scripts/fetch_openalex_publications.py
        timeout-minutes: 30

      - name: Fetch ORCID publications
        if: ${{ github.event.inputs.skip_fetch != 'true' }}
        run: python scripts/fetch_orcid_publications.py
        timeout-minutes: 20

      - name: Combine publications
        run: python scripts/combine_publications.py

      - name: Remove terminated members
        run: python scripts/remove_terminated_members.py

      - name: Check for large changes
        id: check
        run: |
          OLD_COUNT=${{ steps.before.outputs.old_count }}
          OLD_AUTHORS=${{ steps.before.outputs.old_authors }}

          NEW_COUNT=$(python -c "import json; print(json.load(open('data/publications_apa.json'))['metadata']['total_publications'])")
          NEW_AUTHORS=$(python -c "import json; print(json.load(open('data/publications_apa.json'))['metadata']['total_authors'])")

          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "new_authors=$NEW_AUTHORS" >> $GITHUB_OUTPUT

          # Calculate change percentages
          if [ "$OLD_COUNT" -gt 0 ]; then
            CHANGE=$(python -c "print(abs($NEW_COUNT - $OLD_COUNT) * 100 // $OLD_COUNT)")
            DIRECTION=$(python -c "print('increase' if $NEW_COUNT > $OLD_COUNT else 'decrease')")
          else
            CHANGE=0
            DIRECTION="new"
          fi

          echo "change_percent=$CHANGE" >> $GITHUB_OUTPUT
          echo "direction=$DIRECTION" >> $GITHUB_OUTPUT

          echo "## Change Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous:** $OLD_COUNT publications, $OLD_AUTHORS authors" >> $GITHUB_STEP_SUMMARY
          echo "- **New:** $NEW_COUNT publications, $NEW_AUTHORS authors" >> $GITHUB_STEP_SUMMARY
          echo "- **Change:** $CHANGE% $DIRECTION" >> $GITHUB_STEP_SUMMARY

          # Check if change is too large
          if [ "$CHANGE" -gt "${{ env.MAX_CHANGE_PERCENT }}" ] && [ "${{ github.event.inputs.force_update }}" != "true" ]; then
            echo "large_change=true" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## WARNING: Large change detected!" >> $GITHUB_STEP_SUMMARY
            echo "Change of $CHANGE% exceeds threshold of ${{ env.MAX_CHANGE_PERCENT }}%." >> $GITHUB_STEP_SUMMARY
            echo "Update blocked. Review manually and re-run with 'Force update' if intended." >> $GITHUB_STEP_SUMMARY
          else
            echo "large_change=false" >> $GITHUB_OUTPUT
          fi

      - name: Block update if large change
        if: steps.check.outputs.large_change == 'true'
        run: |
          echo "::error::Update blocked: ${{ steps.check.outputs.change_percent }}% ${{ steps.check.outputs.direction }} exceeds ${{ env.MAX_CHANGE_PERCENT }}% threshold"
          echo ""
          echo "Previous: ${{ steps.before.outputs.old_count }} publications"
          echo "New: ${{ steps.check.outputs.new_count }} publications"
          echo ""
          echo "To proceed anyway, re-run with 'Force update' option enabled."
          exit 1

      - name: Check for changes
        id: changes
        if: steps.check.outputs.large_change != 'true'
        run: |
          git diff --quiet data/ || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.changes.outputs.changes == 'true' && steps.check.outputs.large_change != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/
          git commit -m "Update publications data (quarterly) [automated]

          Previous: ${{ steps.before.outputs.old_count }} publications, ${{ steps.before.outputs.old_authors }} authors
          New: ${{ steps.check.outputs.new_count }} publications, ${{ steps.check.outputs.new_authors }} authors
          Change: ${{ steps.check.outputs.change_percent }}% ${{ steps.check.outputs.direction }}

          Run triggered: ${{ github.event_name }}"
          git push

      - name: Create issue if blocked
        if: steps.check.outputs.large_change == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Publication update blocked: ${process.env.CHANGE}% change detected`;
            const body = `## Automated Publication Update Blocked

            The quarterly publication update detected a large change and was blocked for safety.

            | Metric | Previous | New | Change |
            |--------|----------|-----|--------|
            | Publications | ${process.env.OLD_COUNT} | ${process.env.NEW_COUNT} | ${process.env.CHANGE}% ${process.env.DIRECTION} |
            | Authors | ${process.env.OLD_AUTHORS} | ${process.env.NEW_AUTHORS} | - |

            ### Action Required

            1. Review the changes manually
            2. If the change is expected, re-run the workflow with **"Force update"** enabled
            3. If something is wrong, investigate the scripts or API responses

            [View workflow run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['automated', 'needs-review']
            });
        env:
          OLD_COUNT: ${{ steps.before.outputs.old_count }}
          NEW_COUNT: ${{ steps.check.outputs.new_count }}
          OLD_AUTHORS: ${{ steps.before.outputs.old_authors }}
          NEW_AUTHORS: ${{ steps.check.outputs.new_authors }}
          CHANGE: ${{ steps.check.outputs.change_percent }}
          DIRECTION: ${{ steps.check.outputs.direction }}
